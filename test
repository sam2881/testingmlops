def generate_select_expression(df):
    """Generate a DataFrame select expression with properly aliased columns, handling duplicates."""
    seen_aliases = set()
    select_expr = []

    for col_name in df.columns:
        parts = col_name.split('.')
        last_part = parts[-1]  # Last part of the dot-separated name
        simple_name = camel_to_snake(last_part)  # Convert to snake case
        snake_case_name = simple_name
        
        # Handle duplicates by appending the parent's name in snake_case
        while snake_case_name in seen_aliases:
            parent_index = -2 if len(parts) > 1 else None  # Ensures there is a parent part
            parent_name = camel_to_snake(parts[parent_index]) if parent_index else 'base'
            snake_case_name = f"{parent_name}_{simple_name}"
        
        seen_aliases.add(snake_case_name)
        select_expr.append(col(col_name).alias(snake_case_name))

    return df.select(*select_expr)
